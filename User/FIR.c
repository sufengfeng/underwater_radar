/******************** STM32F407 ***********************************************
* TaoBao Address     : 
* Project            : Ultrasonic Range Finder
* HardWare           Ultrasonic Range Finder V1.0    MCU=STM32F407VGT6
* File Name          : main.c
* Author             : MC_benten
* Version            : V1.0
* Date               : 2015/12/31
* Description        : 
					   FIR Filter cal
* Modify			 :
        2015/12/31   :    Initial
		2015/12/31   : 搭建基本测试平台		
********************************************************************************/

#include "FIR.h"


const u16 Coefficient_u16_Const[ NUM_TAPS ] = 
{
         8,     17,      8,      0,      0,      7,     25,      4,      0,
        0,     32,     44,      0,      0,      0,     79,     47,      0,
        0,     49,    134,      4,      0,      0,    153,    159,      0,
        0,     21,    277,     99,      0,      0,    207,    352,      0,
        0,      0,    432,    292,      0,      0,    183,    590,     52,
        0,      0,    529,    561,      0,      0,     41,    795,    288,
        0,      0,    500,    831,      0,      0,      0,    879,    568,
        0,      0,    331,   1001,     73,      0,      0,    794,    794,
        0,      0,     73,   1001,    331,      0,      0,    568,    879,
        0,      0,      0,    831,    500,      0,      0,    288,    795,
       41,      0,      0,    561,    529,      0,      0,     52,    590,
      183,      0,      0,    292,    432,      0,      0,      0,    352,
      207,      0,      0,     99,    277,     21,      0,      0,    159,
      153,      0,      0,      4,    134,     49,      0,      0,     47,
       79,      0,      0,      0,     44,     32,      0,      0,      4,
       25,      7,      0,      0,      8,     17,      8
};
u16 Coefficient_u16_Ram[NUM_TAPS];

void Coefficient_u16_Reverse( void )
{
	u8 i;
	for( i=0 ; i<NUM_TAPS ; i++ )
	{
		Coefficient_u16_Ram[NUM_TAPS-1-i] = Coefficient_u16_Const[i]*4;
	}
}

/* 
Coefficient
KHz:

fstop1 = 98
fstop2 = 120

fpass1 = 108
fPass2 = 110

Amplifier:
Stop:60 dB
Pass:1 dB

*/
#define B_f_NPT  128
const float B_f_Flash[ B_f_NPT ] = 
{
  -0.0002086988534,-0.0002408122964, 0.000140811142,0.0006045056507,0.0003787619935,
  -0.0004548252618,-0.0006382378633,0.0004256262619, 0.001235181815,0.0001554511546,
  -0.001547166379,-0.0009771775221, 0.001587604173, 0.002124215011,-0.0009683896787,
  -0.003201114247,-0.0003415236133, 0.003880351782, 0.002325720852,-0.003680973779,
  -0.004624270834, 0.002290663309, 0.006692105439, 0.000399495184,-0.007809830364,
  -0.004114148673,  0.00730853714, 0.008200483397,-0.004752971232,  -0.0116826212,
  0.0001573498885,  0.01347071864, 0.005911506247, -0.01262796763, -0.01234581321,
   0.008671156131,  0.01767782681,-0.001797845005, -0.02039120905,-0.007024684921,
    0.01930781454,  0.01616522484, -0.01394935045, -0.02362795547, 0.004772257525,
    0.02749281004, 0.006806303747, -0.02639667504, -0.01862471364,   0.0199332647,
    0.02820644528,-0.008857800625,  -0.0333138667,  -0.0049768053,  0.03249339759,
     0.0189581234, -0.02547194995,  -0.0302593559,  0.01329781488,  0.03647173196,
   0.001828619861, -0.03616707027, -0.01700403541,  0.02924920619,  0.02924920619,
   -0.01700403541, -0.03616707027, 0.001828619861,  0.03647173196,  0.01329781488,
    -0.0302593559, -0.02547194995,   0.0189581234,  0.03249339759,  -0.0049768053,
    -0.0333138667,-0.008857800625,  0.02820644528,   0.0199332647, -0.01862471364,
   -0.02639667504, 0.006806303747,  0.02749281004, 0.004772257525, -0.02362795547,
   -0.01394935045,  0.01616522484,  0.01930781454,-0.007024684921, -0.02039120905,
  -0.001797845005,  0.01767782681, 0.008671156131, -0.01234581321, -0.01262796763,
   0.005911506247,  0.01347071864,0.0001573498885,  -0.0116826212,-0.004752971232,
   0.008200483397,  0.00730853714,-0.004114148673,-0.007809830364, 0.000399495184,
   0.006692105439, 0.002290663309,-0.004624270834,-0.003680973779, 0.002325720852,
   0.003880351782,-0.0003415236133,-0.003201114247,-0.0009683896787, 0.002124215011,
   0.001587604173,-0.0009771775221,-0.001547166379,0.0001554511546, 0.001235181815,
  0.0004256262619,-0.0006382378633,-0.0004548252618,0.0003787619935,0.0006045056507,
   0.000140811142,-0.0002408122964,-0.0002086988534
};

void FIR_f( s16 *ps , u32 Num , float AMP )
{
	float tempf;
	u32 i;
	u32 j;
	float B_f_Ram[B_f_NPT];               // Coefficient Used In Sram Accelerate Calculate Performance
//	float th_p = 32760.0/AMP;
//	float th_n = -32760.0/AMP;
	//Deverse Coefficient
	for( i=0; i<B_f_NPT ; i++ )
	{
		B_f_Ram[ B_f_NPT-1-i ] = B_f_Flash[ i ]; 
	}
	
	for( i=0 ; i<Num-B_f_NPT ; i++ )
	{
		tempf=0;
		for( j=0; j<B_f_NPT ; j++ )
		{
			tempf += ps[i+j]*B_f_Ram[j];
		}
		ps[i] = tempf*AMP;
		
//		if( tempf>th_p )
//		{
//			ps[i] = 32760.0;
//		}
//		else
//		{
//			if( tempf<th_n )
//			{
//				ps[i] = -32760.0;
//			}
//			else
//			{
//				ps[i] = tempf*AMP;
//			}
//		}
	}
	for( i=Num-B_f_NPT ; i<Num ; i++ )
	{
		ps[i] = 0 ;
	}
}



